<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <style>
        html, body {
              height: 100vh;
        }
        .fill {
            min-height: 100vh;
        }
    </style>
    <title>Eurovisión</title>
  </head>
  <body class="container-fluid bg-dark" onload="init();">
   <div class="alert alert-warning position-absolute col-9 hidde" style="z-index:9999; margin: 20px auto; left: 0; right: 0; display: none" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        <strong>Error!</strong>Vuelva a intentarlo.
    </div>
    <div class="container">
        <div class="row align-items-center fill">
            <div class="col-12 fill bg-dark">
                 <nav class="row mb-4 mt-2 text-light">
                     <div class="col-12"><h1><i>EuroTurism</i></h1><h5>Encuesta de turismo europeo</h5></div>
                 </nav>
                 <form name="formulario" class="row">
                   <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1"><i class='fas fa-user' style='font-size:24px'></i></span>
                            </div>
                            <input name='usuario' type="text" class="form-control" placeholder="Usuario">
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1"><i class="fas fa-map-marker-alt"></i></span>
                            </div>
                            <input name='pais' type="text" class="form-control" placeholder="País de Residencia" disabled>
                        </div>
                        <div class="input-group mb-3" id='selfie'>
                            <div class="col-6"></div>
                            <button type="button" id="capture" class="col-6 mb-3 btn btn-info" class='none'>Foto de Perfil</button>
                            <video id="video" autoplay style="display:none"></video> 
                            <canvas  id="canvas" height="218px" width="332px" class=""> </canvas>
                        </div>
                        
                        
                        
                        
                   </div>
                   <div class="col-6">
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">10 point</span>
                            </div>
                            <select name="p10" id="p10" required class="form-control"></select>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">8 point </span>
                            </div>
                            <select name="p8" id="p8" required class="form-control"></select>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">6 point </span>
                            </div>
                            <select name="p6" id="p6" required class="form-control"></select>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">4 point </span>
                            </div>
                            <select name="p4" id="p4" required class="form-control"></select>
                        </div>
                        <div class="input-group mb-3">
                            <div class="input-group-prepend">
                                <span class="input-group-text" id="basic-addon1">2 point </span>
                            </div>
                            <select name="p2" id="p2" required class="form-control"></select>
                        </div>
                        <textarea name="comentario" class="form-control mb-3" id="comentario" rows="3" placeholder="Comentario..."></textarea>
                        <button   type="button"  name='button' class="btn btn-primary mb-2 col-12" value="submit">Enviar Datos</button>
                   </div>
                </form>-->
            </div>
        </div>
    </div>
    <div class="col-3 fill bg-secondary p-0"><div id='table'></div></div>
    <div id="mapa" class="col-8 fill m-0 p-0"></div>
    
    <!-- Dependencias Javascript
    highmaps, exporting
    <!-- Orden:
            init()
              |-  asinc -> MapTable()
              |-  asinc -> Options_paises() ++ REPITE 1000ms
              |-  validar_opciones() -> validar() <<  Event change 
              |-  comentario() -> placeholder() << Event change select p10
              
    -->

    <script src="https://code.highcharts.com/maps/highmaps.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <script src="https://code.highcharts.com/mapdata/custom/europe.js"></script>
    <script>
        
    </script>
    <script type="application/javascript">
        //variable global
        window.inic=true; //variable global;
        window.countryCode=''; //codigo del pais de residencia: es
        
        function init(){
            asinc(MapTable,'request=puntuaciones','POST');
            asinc(options_paises,'request=paises','POST');
            setInterval(function(){
                asinc(MapTable,'request=puntuaciones','POST');
            },1000000);
            ubicacion();
            comentario();
            camera();
            document.getElementsByName('button')[0].addEventListener('click',function(){submit()()});
            //crea una escucha, para cuando el usuario cambie opcion en los select.
            for (x = 2; x<=10; x=x+2){ 
                document.getElementById('p'+x).addEventListener('change',function(){validar_opciones(event);});
            }
        }
        
        //Se encarga de hacer las peticiones asincronas.
        function asinc(callback,parametros,method){
            if (window.XMLHttpRequest) {
                ajax = new XMLHttpRequest();
             } else {
                ajax = new ActiveXObject("Microsoft.XMLHTTP");// code for old IE browsers
            }
            ajax.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    callback(this.responseText);
                }
            }
            ajax.open(method, "/eu/servidor/index.php", true);
            ajax.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            ajax.send(parametros);
        }
        
        //crea la tabla y mapa con los datos que se le pasan;
        function MapTable(data){
            
            //linea de desarrollo; eliminar en produción;
            data = [{"code":"es","value":9.24,"comentarios":"voto","nom_pais":"Espa\u00f1a"},{"code":"fr","value":3.42,"comentarios":"votofr","nom_pais":"Francia"}];
            data = JSON.stringify(data);
            
            data = JSON.parse(data);
            tabla(data);
            map(data);
            
            //crea la tabla
            function tabla(data){
                var msg_tabla='<table class="table table-striped table-hover table-sm"><thead class="thead-light"><tr><th scope="col">País</th><th scope="col">Puntuación</th><th scope="col">Último comentario</th><tr></thead><tbody>';
                for (var posicion in data){
                    msg_tabla += '<tr><td>'+data[posicion]['nom_pais']+'</td><td>'+data[posicion]['value']+'</td><td>'+data[posicion]['comentarios']+'</td><tr>';
                }
                msg_tabla += '</tbody><table>';
                document.getElementById('table').innerHTML = msg_tabla;
            }   
            
            //crea el mapa
            function map(data){
                var ArrayData = [];
                for(var i in data){
                    ArrayData.push([data[i]['code'], data[i]['value']]);
                };
                if(window.inic){ //si es la primera vez pintamos el mapa
                    window.mymap = new Highcharts.mapChart('mapa', {
                                chart: {
                                    map: 'custom/europe'
                                },
                                title: {
                                    text: ''
                                },
                                mapNavigation: {
                                    enabled: true,
                                    buttonOptions: {
                                        verticalAlign: 'bottom'
                                    }
                                },
                                colorAxis: {
                                    min: 0
                                },
                                series: [{
                                    data: ArrayData,
                                    name: 'Random data',
                                    states: {
                                        hover: {
                                            color: '#BADA55'
                                        }
                                    },
                                    dataLabels: {
                                        enabled: true,
                                        format: '{point.name}'
                                    }
                                }]
                            });
                    inic=false;
                }else{ //sino solo cambiamos los valores
                    window.mymap.series[0].setData(ArrayData);
                }
            }
        }; 
        
        //inserta la lista de paises seleccionables en los elementos select
        function options_paises(data){
            
            {//linea de desarrollo - eliminar en produccion;
            data = [{"acronimo":"al","nom_pais":"Albania"},{"acronimo":"de","nom_pais":"Alemania"},{"acronimo":"ad","nom_pais":"Andorra"},{"acronimo":"am","nom_pais":"Armenia"},{"acronimo":"at","nom_pais":"Austria"},{"acronimo":"az","nom_pais":"Azerbaiy\u00c3\u00a1n"},{"acronimo":"by","nom_pais":"Belarus"},{"acronimo":"be","nom_pais":"B\u00c3\u00a9lgica"},{"acronimo":"ba","nom_pais":"Bosnia y Herzegovina"},{"acronimo":"bg","nom_pais":"Bulgaria"},{"acronimo":"cz","nom_pais":"Chequia"},{"acronimo":"cy","nom_pais":"Chipre"},{"acronimo":"hr","nom_pais":"Croacia"},{"acronimo":"dk","nom_pais":"Dinamarca"},{"acronimo":"sk","nom_pais":"Eslovaquia"},{"acronimo":"si","nom_pais":"Eslovenia"},{"acronimo":"es","nom_pais":"Espa\u00c3\u00b1a"},{"acronimo":"va","nom_pais":"Estado Vaticano"},{"acronimo":"ee","nom_pais":"Estonia"},{"acronimo":"fi","nom_pais":"Finlandia"},{"acronimo":"fr","nom_pais":"Francia"},{"acronimo":"ge","nom_pais":"Georgia"},{"acronimo":"gr","nom_pais":"Grecia"},{"acronimo":"nl","nom_pais":"Holanda"},{"acronimo":"hu","nom_pais":"Hungr\u00c3\u00ada"},{"acronimo":"ie","nom_pais":"Irlanda"},{"acronimo":"is","nom_pais":"Islandia"},{"acronimo":"it","nom_pais":"Italia"},{"acronimo":"kz","nom_pais":"Kazajst\u00c3\u00a1n"},{"acronimo":"lv","nom_pais":"Letonia"},{"acronimo":"li","nom_pais":"Liechtenstein"},{"acronimo":"lt","nom_pais":"Lituania"},{"acronimo":"lu","nom_pais":"Luxemburgo"},{"acronimo":"mk","nom_pais":"Macedonia"},{"acronimo":"mt","nom_pais":"Malta"},{"acronimo":"md","nom_pais":"Moldavia"},{"acronimo":"mc","nom_pais":"M\u00c3\u00b3naco"},{"acronimo":"no","nom_pais":"Noruega"},{"acronimo":"pl","nom_pais":"Polonia"},{"acronimo":"pt","nom_pais":"Portugal"},{"acronimo":"gb","nom_pais":"Reino Unido"},{"acronimo":"ro","nom_pais":"Ruman\u00c3\u00ada"},{"acronimo":"ru","nom_pais":"Rusia"},{"acronimo":"sm","nom_pais":"San Marino"},{"acronimo":"se","nom_pais":"Suecia"},{"acronimo":"ch","nom_pais":"Suiza"},{"acronimo":"ua","nom_pais":"Ucrania"}];
            data = JSON.stringify(data);}

            paises = JSON.parse(data);
            function query_paises(){
                var msg_paises='<option value="'+Math.random()+'" selected disabled hidden>Seleccione un país</option>';
                for (posicion in paises){
                    msg_paises += '<option value='+paises[posicion]["acronimo"]+'>'+paises[posicion]["nom_pais"]+'</option>';
                }
                return msg_paises;
            }
            //inserta los paises como <option> en cada select
            for (i = 2; i<=10; i=i+2){ 
                document.getElementById('p'+i).innerHTML+=query_paises();
            }
        }
        
        //evita que selecciones a un pais varias veces o que selecciones tu pais de residencia
        function validar_opciones(id){

               //Genero un array con todos los paises seleccionados
                var paises_seleccionados = new Array(); 
                for (i = 2; i<=10; i=i+2){ 
                    paises_seleccionados.push(document.getElementById("p"+i).value); 
                }
                
                //Creo un objeto, de manera que quito los valores repetidos
                objPaises = new Set(paises_seleccionados); 
                if(paises_seleccionados.length != objPaises.size){ //Si todos los paises son distintos, la longitud de ambos debera ser igual
                    document.getElementById(id.target.name)[0].selected = true;
                    alert('Ya has seleccionado anteriormente ese país! Un voto por país. Gracias');
                }
                //compruebo que no coincida con el pais de residencia
                if(document.getElementById(id.target.name).value == window.countryCode){
                    document.getElementById(id.target.name)[0].selected = true;
                    alert('No puedes votar tu país de residencia.');
                }
        };    

        
        
        function comentario(){
            function placeholder(){
                var element = document.getElementById('p10');
                var opcion = element.options[element.selectedIndex].text;
                var msg = '¿Por qué has elegido '+opcion+' como mejor destino?';
                document.getElementById('comentario').placeholder=msg;
            }
            document.getElementById('p10').addEventListener('change',function(){comentario()()});
            return placeholder;
        }
        function submit(){
            function form(){
                var elements = ['usuario','p10','p8','p6','p4','p2','comentario','button'];
                var param = '';
                var control_ok = true;
                for (i in elements){
                    valor = document.getElementsByName(elements[i])[0].value;
                    if(valor=='' || !isNaN(valor)){
                        alert('verifique el formulario');
                        control_ok=false;
                        break;
                    }
                    param += elements[i]+'='+valor+'&';
                }
                param = param.slice(0, -1); //quita &
                if(control_ok){asinc(alert,param,'POST');}
            };
            return form;
        }
        
        
        function ubicacion(){
           if ("geolocation" in navigator) {
               var options = {
                  enableHighAccuracy: false,
                  timeout: 8000,
                  maximumAge: 0
               };
               function success(position){
                   var param = 'request=pais_residencia&lat='+position.coords.latitude+'&lon='+position.coords.longitude;
                   asinc(pais_residencia,param,'POST');
               };
               function error(){
                   console.log('aqui estoy') ;
                   var param = 'request=pais_residencia&lat=null&lon=null';
                   asinc(pais_residencia,param,'POST');  
               };
               navigator.geolocation.getCurrentPosition(success, error, options);
           }else{
               error();
           }
        }
        function pais_residencia(data){
            //linea de desarrollo. Eliminar en produccion;
            data = {"country":"Espa\u00f1a","country_code":"es"};
            data = JSON.stringify(data);
            
            if(data=='error'){
                document.getElementsByName('pais')[0].disabled=false;
            }else{
                var data=JSON.parse(data);
                var element = document.getElementsByName('pais')[0].value=data['country'];
                window.countryCode = data['country_code'];
            }
        }
        
        
        
        
        var canvas = document.getElementById('canvas'),
            contexto_canvas = canvas.getContext("2d"),
            img = document.getElementById('video'),
            botton_snap = document.getElementById('capture');
            flag_camera=true; //primera vez
            flag_button=true; //preguntar
        
        function camera(){
            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                if(flag_camera){
                    botton_snap.textContent='Tomar fotografía de perfil';
                }else{
                    flag_camera = false;
                    botton_snap.textContent='Sonrie!';
                }

                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(function(stream) {
                        img.srcObject = stream;
                        img.play();

                    repet = setInterval(function(){
                            contexto_canvas.drawImage(img,0,0,canvas.width,canvas.height); //señal de video
                            contexto_canvas.globalAlpha=0.05; //transparencia
                            contexto_canvas.lineWidth = 2;
                            contexto_canvas.fillStyle="#f00"; //color de fondo
                            contexto_canvas.fillRect(0,0,canvas.width,canvas.height); // todo el recuadro

                            //semicirculo de cabeza
                            var startingX = 139, startingY = 192, firstX = -12, firstY = -24, secondX = 344, secondY = -24, endingX = 193, endingY = 192;
                            contexto_canvas.beginPath();
                            contexto_canvas.moveTo( startingX, startingY );
                            contexto_canvas.bezierCurveTo( firstX, firstY, secondX, secondY, endingX, endingY );
                            contexto_canvas.stroke();

                        },0);
                       // contexto_canvas.drawImage(img,0,0);
                    });

                    botton_snap.addEventListener('click',function(){
                        if(flag_button){ //estaba corriendo
                            clearInterval(repet);
                            repet=null;
                            contexto_canvas.clearRect(0, 0, canvas.width, canvas.height); //limpiar canvas
                            contexto_canvas.globalAlpha=1; //transparencia
                            contexto_canvas.drawImage(img,0,0,canvas.width,canvas.height); //ultimo fotograma de video lo muestro en canvas
                            botton_snap.textContent='Uhm! No me convenve. Otra';
                            img.getVideoTracks()[0].stop();
                            flag_button=false;
                        }else{
                            flag_button=true;
                            camera();
                        }


                    });
                
                
            function capt_error(){
                alert('Su navegador no soporta API Camara o ha denegado el acceso');
            }
          }
        }
        /*
       // Grab elements, create settings, etc.
var video = document.getElementById('video');

// Get access to the camera!


        
        // Elements for taking the snapshot
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');
var video = document.getElementById('video');

// Trigger photo take
document.getElementById("snap").addEventListener("click", function() {
	context.drawImage(video, 0, 0, 640, 480);
});*/
        
    </script>
    
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
    </body>
</html>
